<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Crypto Dashboard v5</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --success: #22c55e;
            --danger: #ef4444; --warning: #f59e0b; --gray: #64748b;
            --card-bg: #ffffff; --bg-color: #f1f5f9; --text-color: #1e2_sub --><!-- ### ПОЛНЫЙ JS-КОД ИЗ V3 ТЕПЕРЬ ЗДЕСЬ ### -->
        let portfolio = [];
        let nextTokenId = 1;

        // --- TELEGRAM INTEGRATION & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                
                const root = document.documentElement;
                if (tg.colorScheme === 'dark') {
                    root.style.setProperty('--card-bg', '#1c2431');
                    root.style.setProperty('--bg-color', '#131720');
                    root.style.setProperty('--text-color', '#ffffff');
                    root.style.setProperty('--gray', '#7a8999');
                }
                
                if (tg.BackButton.isVisible) {
                    tg.BackButton.hide();
                }
                
            } catch (e) {
                console.error("Telegram WebApp script not found or failed.", e);
            }

            loadData();
            updateDisplay();
            syncPrices();
        });

        // --- MODAL & FORM FUNCTIONS ---
        function openAddTokenModal() {
            document.getElementById('tokenForm').reset();
            document.getElementById('editTokenId').value = '';
            document.getElementById('modalTitle').textContent = 'Добавить токен';
            document.getElementById('searchSection').style.display = 'block';
            document.getElementById('dcaEditor').innerHTML = '';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('tokenModal').classList.add('active');
        }

        function openEditTokenModal(tokenId) {
            const token = portfolio.find(t => t.id === tokenId);
            if (!token) return;

            document.getElementById('tokenForm').reset();
            document.getElementById('modalTitle').textContent = 'Изменить токен';
            document.getElementById('searchSection').style.display = 'none';

            document.getElementById('editTokenId').value = token.id;
            document.getElementById('coingeckoId').value = token.coingeckoId;
            document.getElementById('tokenSymbol').value = token.symbol;
            document.getElementById('tokenSymbol').dataset.iconUrl = token.iconUrl;
            document.getElementById('tokenName').value = token.name;
            document.getElementById('tokenAmount').value = token.amount;
            document.getElementById('tokenBuyPrice').value = token.avgPrice;
            document.getElementById('tokenStopLoss').value = token.stopLoss || '';

            const dcaEditor = document.getElementById('dcaEditor');
            dcaEditor.innerHTML = '';
            if (token.dcaPlan) {
                token.dcaPlan.forEach(dca => addDcaRow(dca.condition, dca.amount));
            }

            document.getElementById('tokenModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function addDcaRow(condition = '', amount = '') {
            const editor = document.getElementById('dcaEditor');
            const row = document.createElement('div');
            row.className = 'dca-row';
            row.innerHTML = `
                <input type="text" class="dca-input" placeholder="Условие (напр. < 1.5$)" value="${condition}">
                <input type="number" step="any" class="dca-input" placeholder="Сумма ($)" value="${amount}">
                <button type="button" class="remove-dca-btn" onclick="this.parentElement.remove()">×</button>
            `;
            editor.appendChild(row);
        }

        function saveToken(event) {
            event.preventDefault();
            const editId = document.getElementById('editTokenId').value;
            if (editId) {
                const token = portfolio.find(t => t.id === parseInt(editId));
                if (token) {
                    token.amount = parseFloat(document.getElementById('tokenAmount').value);
                    token.avgPrice = parseFloat(document.getElementById('tokenBuyPrice').value);
                    token.totalInvested = token.amount * token.avgPrice;
                    token.stopLoss = parseFloat(document.getElementById('tokenStopLoss').value) || 0;
                    token.dcaPlan = [];
                    document.querySelectorAll('#dcaEditor .dca-row').forEach(row => {
                        const condition = row.children[0].value;
                        const amount = parseFloat(row.children[1].value);
                        if (condition && amount > 0) {
                            token.dcaPlan.push({ condition, amount });
                        }
                    });
                    showNotification('Токен успешно обновлен!', 'success');
                }
            } else {
                 const coingeckoId = document.getElementById('coingeckoId').value;
                if (!coingeckoId) {
                    showNotification('Пожалуйста, найдите и выберите токен.', 'warning');
                    return;
                }
                const token = {
                    id: nextTokenId++, coingeckoId: coingeckoId,
                    symbol: document.getElementById('tokenSymbol').value,
                    name: document.getElementById('tokenName').value,
                    iconUrl: document.getElementById('tokenSymbol').dataset.iconUrl,
                    amount: parseFloat(document.getElementById('tokenAmount').value),
                    avgPrice: parseFloat(document.getElementById('tokenBuyPrice').value),
                    currentPrice: parseFloat(document.getElementById('tokenBuyPrice').value),
                    totalInvested: parseFloat(document.getElementById('tokenAmount').value) * parseFloat(document.getElementById('tokenBuyPrice').value),
                    stopLoss: parseFloat(document.getElementById('tokenStopLoss').value) || 0,
                    dcaPlan: []
                };
                document.querySelectorAll('#dcaEditor .dca-row').forEach(row => {
                    const condition = row.children[0].value;
                    const amount = parseFloat(row.children[1].value);
                    if (condition && amount > 0) token.dcaPlan.push({ condition, amount });
                });
                portfolio.push(token);
                showNotification(`${token.symbol} добавлен в портфель`);
                syncPrices();
            }
            closeModal('tokenModal');
            updateDisplay();
            saveData();
        }

        // --- API & DATA FUNCTIONS ---
        async function searchTokens() {
            const query = document.getElementById('tokenSearch').value;
            const resultsDiv = document.getElementById('searchResults');
            if (!query) return;
            resultsDiv.innerHTML = 'Идет поиск...';
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/search?query=${query}`);
                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                resultsDiv.innerHTML = '';
                if (data.coins.length === 0) { resultsDiv.innerHTML = 'Ничего не найдено.'; return; }
                data.coins.slice(0, 10).forEach(coin => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.onclick = () => selectToken(coin.id, coin.symbol.toUpperCase(), coin.name, coin.thumb);
                    item.innerHTML = `<img src="${coin.thumb}" alt="${coin.name} icon"><span><strong>${coin.symbol.toUpperCase()}</strong> - ${coin.name}</span>`;
                    resultsDiv.appendChild(item);
                });
            } catch (error) {
                resultsDiv.innerHTML = 'Ошибка при поиске.';
                showNotification('Не удалось выполнить поиск.', 'error');
            }
        }

        function selectToken(id, symbol, name, iconUrl) {
            document.getElementById('coingeckoId').value = id;
            document.getElementById('tokenSymbol').value = symbol;
            document.getElementById('tokenName').value = name;
            document.getElementById('tokenSymbol').dataset.iconUrl = iconUrl;
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('tokenSearch').value = `${name} (${symbol})`;
        }

        // ### ИСПРАВЛЕННАЯ ФУНКЦИЯ ###
        async function syncPrices() {
            // Вот он, наш "охранник"!
            if (portfolio.length === 0) {
                console.log("Портфель пуст, обновление цен не требуется.");
                return; 
            }

            const syncButton = document.getElementById('syncButton');
            syncButton.classList.add('loading');
            syncButton.textContent = '...';
            syncButton.disabled = true;
            
            const ids = portfolio.map(token => token.coingeckoId).join(',');
            const url = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const prices = await response.json();
                portfolio.forEach(token => {
                    if (prices[token.coingeckoId] && prices[token.coingeckoId].usd) {
                        token.currentPrice = prices[token.coingeckoId].usd;
                    }
                });
                showNotification('Цены успешно обновлены!', 'success');
            } catch (error) {
                showNotification('Не удалось обновить цены.', 'error');
            } finally {
                updateDisplay();
                saveData();
                syncButton.classList.remove('loading');
                syncButton.textContent = 'Обновить';
                syncButton.disabled = false;
            }
        }
        
        function removeToken(tokenId) {
            if(confirm('Вы уверены, что хотите удалить этот токен?')) {
                portfolio = portfolio.filter(t => t.id !== tokenId);
                updateDisplay();
                saveData();
                showNotification('Токен удален.', 'success');
            }
        }

        // --- UI & DISPLAY ---
        function updateDisplay() {
            updatePortfolioCards();
            updateStats();
        }

        function updatePortfolioCards() {
            const container = document.getElementById('portfolioCards');
            const placeholder = document.getElementById('portfolioPlaceholder');
            if (portfolio.length === 0) { container.innerHTML = ''; placeholder.style.display = 'block'; return; }
            placeholder.style.display = 'none';
            container.innerHTML = portfolio.map(token => {
                const currentValue = token.amount * token.currentPrice;
                const pnl = currentValue - token.totalInvested;
                const pnlPercent = token.totalInvested > 0 ? (pnl / token.totalInvested * 100) : 0;
                const stopLossHtml = token.stopLoss > 0 ? `<div class="stop-loss">SL: $${token.stopLoss}</div>` : '';
                const dcaPlanHtml = token.dcaPlan && token.dcaPlan.length > 0 ? token.dcaPlan.map(dca => `<div class="dca-item">DCA: ${dca.condition} (${dca.amount}$)</div>`).join('') : '';
                return `
                <div class="token-card">
                    <div class="token-card-header">
                        <img src="${token.iconUrl}" class="token-icon" alt="${token.name} icon">
                        <div class="token-info"><div class="token-symbol">${token.symbol}</div><div class="token-name">${token.name}</div></div>
                        <div class="token-pnl ${pnl >= 0 ? 'positive' : 'negative'}"><div>${pnl >= 0 ? '+' : ''}${pnl.toLocaleString('en-US',{minimumFractionDigits:2, maximumFractionDigits:2})}$</div><div>${pnlPercent.toFixed(2)}%</div></div>
                    </div>
                    <div class="token-card-body">
                        <div class="data-point"><div class="data-label">Кол-во</div><div class="data-value">${token.amount.toLocaleString('en-US', {maximumFractionDigits: 6})}</div></div>
                        <div class="data-point"><div class="data-label">Ср. цена входа</div><div class="data-value">$${token.avgPrice.toLocaleString('en-US',{maximumFractionDigits: 2})}</div></div>
                        <div class="data-point"><div class="data-label">Текущая цена</div><div class="data-value">$${token.currentPrice.toLocaleString('en-US',{maximumFractionDigits: 2})}</div></div>
                        <div class="data-point"><div class="data-label">Стоимость</div><div class="data-value">$${currentValue.toLocaleString('en-US',{maximumFractionDigits: 2})}</div></div>
                        <div class="data-point strategy-details"><div class="data-label">Стратегия</div>${stopLossHtml}${dcaPlanHtml}</div>
                    </div>
                    <div class="token-card-actions">
                        <button class="btn btn-warning" onclick="openEditTokenModal(${token.id})" style="flex:1;">Изменить</button>
                        <button class="btn btn-danger" onclick="removeToken(${token.id})" style="flex:1;">Удалить</button>
                    </div>
                </div>`;
            }).join('');
        }

        function updateStats() {
            let totalInvested = portfolio.reduce((sum, token) => sum + token.totalInvested, 0);
            let totalValue = portfolio.reduce((sum, token) => sum + (token.amount * token.currentPrice), 0);
            const totalPnL = totalValue - totalInvested;
            const pnlPercent = totalInvested > 0 ? (totalPnL / totalInvested * 100) : 0;

            document.getElementById('totalBalance').textContent = `$${totalValue.toLocaleString('en-US',{maximumFractionDigits: 2})}`;
            document.getElementById('totalInvested').textContent = `$${totalInvested.toLocaleString('en-US',{maximumFractionDigits: 2})}`;
            document.getElementById('totalPnL').textContent = `$${totalPnL.toLocaleString('en-US',{maximumFractionDigits: 2})}`;
            const pnlChangeEl = document.getElementById('pnlChange');
            pnlChangeEl.textContent = `${pnlPercent.toFixed(2)}%`;
            pnlChangeEl.style.color = pnlPercent >= 0 ? 'var(--success)' : 'var(--danger)';
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // --- LOCAL STORAGE ---
        function saveData() {
            localStorage.setItem('cryptoDashboardV5', JSON.stringify({ portfolio, nextTokenId }));
        }

        function loadData() {
            // Fallback for seamless upgrade
            let saved = localStorage.getItem('cryptoDashboardV5') || localStorage.getItem('cryptoDashboardV4');
            if (saved) {
                const data = JSON.parse(saved);
                portfolio = data.portfolio || [];
                nextTokenId = data.nextTokenId || 1;
            }
        }
    </script>
</body>
</html>
