<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Crypto Dashboard v4</title>
    <!-- 1. –î–û–ë–ê–í–ò–õ–ò –û–§–ò–¶–ò–ê–õ–¨–ù–´–ô –°–ö–†–ò–ü–¢ TELEGRAM -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --success: #22c55e;
            --danger: #ef4444; --warning: #f59e0b; --dark: #1e293b;
            --light: #f8fafc; --gray: #64748b; --card-bg: #ffffff;
            --bg-color: #f1f5f9; --text-color: #1e293b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            padding: 15px;
            -webkit-font-smoothing: antialiased;
        }
        .dashboard { max-width: 1200px; margin: 0 auto; }
        .header { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .logo { font-size: 24px; font-weight: 700; }
        .header-actions { display: flex; gap: 10px; }
        .btn { padding: 10px 15px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--gray); color: var(--gray); }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .stat-card { background: var(--bg-color); padding: 12px; border-radius: 12px; }
        .stat-label { font-size: 12px; color: var(--gray); margin-bottom: 4px; }
        .stat-value { font-size: 18px; font-weight: 700; }
        
        /* 2. –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ö–ê–†–¢–û–ß–ï–ö –ü–û–†–¢–§–ï–õ–Ø */
        .portfolio-cards { display: flex; flex-direction: column; gap: 15px; }
        .token-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .token-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .token-icon { width: 40px; height: 40px; border-radius: 50%; }
        .token-info { flex-grow: 1; }
        .token-symbol { font-weight: 600; font-size: 16px; }
        .token-name { font-size: 13px; color: var(--gray); }
        .token-pnl { text-align: right; font-weight: 600; }
        .token-pnl.positive { color: var(--success); }
        .token-pnl.negative { color: var(--danger); }
        .token-card-body { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .data-point { display: flex; flex-direction: column; gap: 2px; }
        .data-label { font-size: 12px; color: var(--gray); }
        .data-value { font-weight: 600; font-size: 14px; }
        .strategy-details { grid-column: 1 / -1; }
        .strategy-details .stop-loss { color: var(--danger); font-weight: 600; }
        .strategy-details .dca-item { color: var(--primary); font-size: 13px; }
        .token-card-actions { border-top: 1px solid var(--bg-color); margin-top: 15px; padding-top: 15px; display: flex; gap: 10px; }
        
        /* –°—Ç–∞—Ä–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
        .portfolio-table { display: none; }
        #portfolioPlaceholder { text-align: center; padding: 40px; color: var(--gray); background: var(--card-bg); border-radius: 16px; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏ –ø—Ä–æ—á–µ–µ - —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; padding: 15px; }
        .modal-content { background: var(--card-bg); border-radius: 16px; padding: 24px; max-width: 500px; width: 100%; }
        /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω ... */
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <div class="header-top">
                <div class="logo">üìà Trading Dashboard</div>
                <div class="header-actions">
                    <button id="syncButton" class="btn btn-outline" onclick="syncPrices()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button class="btn btn-primary" onclick="openAddTokenModal()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div><div class="stat-value" id="totalBalance">$0.00</div></div>
                <div class="stat-card"><div class="stat-label">–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ</div><div class="stat-value" id="totalInvested">$0.00</div></div>
                <div class="stat-card"><div class="stat-label">P&L ($)</div><div class="stat-value" id="totalPnL">$0.00</div></div>
                <div class="stat-card"><div class="stat-label">P&L (%)</div><div class="stat-value" id="pnlChange">0%</div></div>
            </div>
        </div>

        <!-- 3. –ù–û–í–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –ö–ê–†–¢–û–ß–ï–ö -->
        <div class="portfolio-cards" id="portfolioCards">
            <div id="portfolioPlaceholder">–ü–æ—Ä—Ç—Ñ–µ–ª—å –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–æ–∫–µ–Ω.</div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (HTML –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è) -->
    <div class="modal" id="tokenModal">
        <!-- ... —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ... -->
    </div>
    <div class="notification" id="notification"></div>
    
    <script>
        // --- DATA & API SCRIPTS (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        let portfolio = [];
        let nextTokenId = 1;
        // ... –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ API, –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —Ç.–¥. ...
        
        // --- –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø ---
        function updateDisplay() {
            updatePortfolioCards(); // –¢–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
            updateStats();
        }

        function updatePortfolioCards() {
            const container = document.getElementById('portfolioCards');
            const placeholder = document.getElementById('portfolioPlaceholder');

            if (portfolio.length === 0) {
                container.innerHTML = '';
                placeholder.style.display = 'block';
                return;
            }
            
            placeholder.style.display = 'none';
            container.innerHTML = portfolio.map(token => {
                const currentValue = token.amount * token.currentPrice;
                const pnl = currentValue - token.totalInvested;
                const pnlPercent = token.totalInvested > 0 ? (pnl / token.totalInvested * 100) : 0;
                
                const stopLossHtml = token.stopLoss > 0 ? `<div class="stop-loss">SL: $${token.stopLoss}</div>` : '';
                const dcaPlanHtml = token.dcaPlan && token.dcaPlan.length > 0
                    ? token.dcaPlan.map(dca => `<div class="dca-item">DCA: ${dca.condition} (${dca.amount}$)</div>`).join('')
                    : '<div>–ù–µ—Ç –ø–ª–∞–Ω–∞ DCA</div>';
                
                return `
                <div class="token-card">
                    <div class="token-card-header">
                        <img src="${token.iconUrl}" class="token-icon" alt="${token.name} icon">
                        <div class="token-info">
                            <div class="token-symbol">${token.symbol}</div>
                            <div class="token-name">${token.name}</div>
                        </div>
                        <div class="token-pnl ${pnl >= 0 ? 'positive' : 'negative'}">
                            <div>${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}$</div>
                            <div>${pnlPercent.toFixed(2)}%</div>
                        </div>
                    </div>
                    <div class="token-card-body">
                        <div class="data-point"><div class="data-label">–ö–æ–ª-–≤–æ</div><div class="data-value">${token.amount.toLocaleString('en-US')}</div></div>
                        <div class="data-point"><div class="data-label">–°—Ä. —Ü–µ–Ω–∞ –≤—Ö–æ–¥–∞</div><div class="data-value">$${token.avgPrice.toLocaleString('en-US')}</div></div>
                        <div class="data-point"><div class="data-label">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</div><div class="data-value">$${token.currentPrice.toLocaleString('en-US')}</div></div>
                        <div class="data-point"><div class="data-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</div><div class="data-value">$${currentValue.toLocaleString('en-US')}</div></div>
                        <div class="data-point strategy-details">
                            <div class="data-label">–°—Ç—Ä–∞—Ç–µ–≥–∏—è</div>
                            ${stopLossHtml}${dcaPlanHtml}
                        </div>
                    </div>
                    <div class="token-card-actions">
                        <button class="btn btn-warning" onclick="openEditTokenModal(${token.id})" style="flex:1;">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                        <button class="btn btn-danger" onclick="removeToken(${token.id})" style="flex:1;">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        // --- 4. –ù–û–í–´–ô –°–ö–†–ò–ü–¢ –î–õ–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–ò –° TELEGRAM ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const tg = window.Telegram.WebApp;
                tg.ready(); // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
                
                // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã Telegram
                const root = document.documentElement;
                if (tg.colorScheme === 'dark') {
                    root.style.setProperty('--card-bg', '#1c2431');
                    root.style.setProperty('--bg-color', '#131720');
                    root.style.setProperty('--text-color', '#ffffff');
                    root.style.setProperty('--gray', '#7a8999');
                }
                
                // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –≤ —à–∞–ø–∫–µ Mini App
                tg.BackButton.show();
                tg.BackButton.onClick(() => tg.close());
                
            } catch (e) {
                console.error("Telegram WebApp script not found or failed.", e);
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (—Å—Ç–∞—Ä—ã–π –∫–æ–¥)
            loadData();
            updateDisplay();
            syncPrices();
        });

        // –û—Å—Ç–∞–ª—å–Ω–æ–π JS-–∫–æ–¥ (updateStats, saveData, loadData, –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏ —Ç.–¥.) 
        // –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ, –∫–∞–∫ –≤ dashboard_v3.html
    </script>
</body>
</html>
